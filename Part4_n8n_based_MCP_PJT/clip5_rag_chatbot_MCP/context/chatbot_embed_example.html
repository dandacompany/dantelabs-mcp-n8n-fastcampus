<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n ì±—ë´‡ ì„ë² ë“œ í…ŒìŠ¤íŠ¸</title>
    <style>
        /* í˜ì´ì§€ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ê°€ìƒ ëœë”©í˜ì´ì§€) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 40px;
            background-color: #f4f7f6;
            color: #333;
            height: 200vh; /* í˜ì´ì§€ê°€ ê¸¸ë‹¤ëŠ” ê²ƒì„ ë³´ì—¬ì£¼ê¸° ìœ„í•œ ìŠ¤í¬ë¡¤ ìƒì„± */
        }
        h1 {
            color: #003366;
        }
        p {
            line-height: 1.6;
        }

        /* --- ì±—ë´‡ ìœ„ì ¯ ìŠ¤íƒ€ì¼ --- */

        /* í”Œë¡œíŒ… ë²„íŠ¼ (ì±—ë´‡ í† ê¸€) */
        #chat-toggle-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #007bff; /* ì›í•˜ëŠ” ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš” */
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out;
            z-index: 9998;
        }

        #chat-toggle-button:hover {
            transform: scale(1.1);
        }

        /* ì±—ë´‡ ì»¨í…Œì´ë„ˆ */
        #chat-widget-container {
            position: fixed;
            bottom: 90px; /* ë²„íŠ¼ ë†’ì´ + ì—¬ë°± */
            right: 20px;
            width: 370px;
            height: 600px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
            overflow: hidden; /* ë‚´ë¶€ iframeì´ ë‘¥ê·¼ ëª¨ì„œë¦¬ë¥¼ ë„˜ì§€ ì•Šë„ë¡ */
            z-index: 9999;
            
            /* ì´ˆê¸° ìƒíƒœ (ìˆ¨ê¹€) */
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none; /* ìˆ¨ê²¨ì ¸ ìˆì„ ë•Œ í´ë¦­ ë°©ì§€ */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        /* ì±—ë´‡ ì»¨í…Œì´ë„ˆê°€ ë³´ì¼ ë•Œì˜ ìŠ¤íƒ€ì¼ */
        #chat-widget-container.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto; /* ë³´ì¼ ë•Œ ë‹¤ì‹œ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ */
        }

        /* n8n ì±—ë´‡ iframe */
        #n8n-chat-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>

    <h1>ê°€ìƒì˜ ëœë”© í˜ì´ì§€ì…ë‹ˆë‹¤</h1>
    <p>ì´ í˜ì´ì§€ëŠ” n8n ì±—ë´‡ì„ ì„ë² ë“œí•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•œ ì˜ˆì‹œì…ë‹ˆë‹¤.</p>
    <p>í˜ì´ì§€ ìš°ì¸¡ í•˜ë‹¨ì˜ íŒŒë€ìƒ‰ ë™ê·¸ë¼ë¯¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì±—ë´‡ê³¼ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
    <br>
    <p>í˜ì´ì§€ë¥¼ ìŠ¤í¬ë¡¤í•´ë„ ë²„íŠ¼ê³¼ ì±„íŒ…ì°½ì€ í•­ìƒ ê°™ì€ ìœ„ì¹˜ì— ê³ ì •ë©ë‹ˆë‹¤.</p>

    <div id="chat-widget-container">
        <iframe id="n8n-chat-iframe" src="" title="n8n Chat"></iframe>
    </div>

    <button id="chat-toggle-button" aria-label="ì±„íŒ… ì—´ê¸°">
        ğŸ’¬
    </button>
    
    <script>
        // DOM ìš”ì†Œê°€ ëª¨ë‘ ë¡œë“œëœ í›„ì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => {

            // í•„ìš”í•œ ìš”ì†Œë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const chatToggleButton = document.getElementById('chat-toggle-button');
            const chatWidgetContainer = document.getElementById('chat-widget-container');
            const n8nIframe = document.getElementById('n8n-chat-iframe');

            // n8n Webhook URLì„ ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
            const n8nWebhookUrl = 'http://localhost:5678/webhook/4224c4d7-bdb4-462f-b60e-517412a3bb6c';

            // iframeì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸
            let isChatLoaded = false;
            let isRecursionDetected = false;

            // === ë°©ì–´ ë¡œì§ 1: ì¬ê·€ ë¡œë”© ê°ì§€ ë° ë°©ì§€ ===
            function detectRecursion() {
                // í˜„ì¬ í˜ì´ì§€ê°€ iframe ë‚´ë¶€ì—ì„œ ë¡œë“œë˜ê³  ìˆëŠ”ì§€ í™•ì¸
                if (window !== window.top) {
                    console.warn('ğŸš¨ ì¬ê·€ ë¡œë”© ê°ì§€: iframe ë‚´ë¶€ì—ì„œ ì‹¤í–‰ ì¤‘');
                    isRecursionDetected = true;
                    
                    // iframe ë‚´ë¶€ì—ì„œëŠ” ì±—ë´‡ ê¸°ëŠ¥ ì™„ì „ ë¹„í™œì„±í™”
                    chatToggleButton.style.display = 'none';
                    chatWidgetContainer.style.display = 'none';
                    
                    // ëª¨ë“  iframe ìš”ì†Œ ë¹„í™œì„±í™”
                    const allIframes = document.querySelectorAll('iframe');
                    allIframes.forEach(iframe => {
                        iframe.style.display = 'none';
                        iframe.src = 'about:blank';
                    });
                    
                    // í˜ì´ì§€ ìƒë‹¨ì— ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
                    const warningDiv = document.createElement('div');
                    warningDiv.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        background: #ff4444;
                        color: white;
                        padding: 10px;
                        text-align: center;
                        z-index: 10000;
                        font-weight: bold;
                    `;
                    warningDiv.textContent = 'âš ï¸ ì¬ê·€ ë¡œë”© ê°ì§€ë¨ - ì±—ë´‡ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤';
                    document.body.insertBefore(warningDiv, document.body.firstChild);
                    
                    // ì¶”ê°€ ì•ˆì „ì¥ì¹˜: ëª¨ë“  í´ë¦­ ì´ë²¤íŠ¸ ì°¨ë‹¨
                    document.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.warn('ì¬ê·€ ê°ì§€ë¡œ ì¸í•´ í´ë¦­ ì°¨ë‹¨');
                    }, true);
                    
                    return true;
                }
                return false;
            }

            // === ë°©ì–´ ë¡œì§ 2: URL ê²€ì¦ ===
            function validateWebhookUrl() {
                const currentUrl = window.location.href;
                
                // ì¬ê·€ ë¡œë”© ë°©ì§€: webhook URLì´ í˜„ì¬ í˜ì´ì§€ URLì„ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸
                if (n8nWebhookUrl.includes(currentUrl) || currentUrl.includes(n8nWebhookUrl)) {
                    console.error('ğŸš¨ URL ê²€ì¦ ì‹¤íŒ¨: ì¬ê·€ ë¡œë”© ìœ„í—˜');
                    isRecursionDetected = true;
                    return false;
                }
                
                // webhook URL í˜•ì‹ ê²€ì¦
                if (!n8nWebhookUrl.startsWith('http') || !n8nWebhookUrl.includes('/webhook/')) {
                    console.error('ğŸš¨ ì˜ëª»ëœ webhook URL í˜•ì‹');
                    return false;
                }
                
                return true;
            }ÃŸ

            // === ë°©ì–´ ë¡œì§ 3: iframe ë¡œë“œ ì˜¤ë¥˜ ì²˜ë¦¬ ===
            function setupIframeErrorHandling() {
                n8nIframe.addEventListener('error', (e) => {
                    console.error('ğŸš¨ iframe ë¡œë“œ ì˜¤ë¥˜:', e);
                    showErrorMessage('ì±—ë´‡ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                });

                n8nIframe.addEventListener('load', () => {
                    // iframe ë¡œë“œ í›„ì—ë„ ì¬ê·€ í™•ì¸
                    setTimeout(() => {
                        try {
                            const iframeDoc = n8nIframe.contentDocument || n8nIframe.contentWindow.document;
                            if (iframeDoc && iframeDoc.location.href === window.location.href) {
                                console.error('ğŸš¨ iframe ì¬ê·€ ë¡œë”© ê°ì§€');
                                showErrorMessage('ì±—ë´‡ URLì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                                n8nIframe.src = 'about:blank';
                            }
                        } catch (e) {
                            // Cross-origin ì œí•œìœ¼ë¡œ ì¸í•œ ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
                            console.log('iframe ë‚´ìš© í™•ì¸ ë¶ˆê°€ (ì •ìƒì ì¸ ê²½ìš°)');
                        }
                    }, 1000);
                });
            }

            // === ë°©ì–´ ë¡œì§ 4: ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ ===
            function showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #ff4444;
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    z-index: 10001;
                    text-align: center;
                    max-width: 300px;
                `;
                errorDiv.innerHTML = `
                    <h3>âš ï¸ ì˜¤ë¥˜</h3>
                    <p>${message}</p>
                    <button onclick="this.parentElement.remove()" style="
                        background: white;
                        color: #ff4444;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        margin-top: 10px;
                    ">í™•ì¸</button>
                `;
                document.body.appendChild(errorDiv);
            }

            // === ë°©ì–´ ë¡œì§ 5: ì•ˆì „í•œ iframe ë¡œë“œ ===
            function safeLoadIframe() {
                if (isRecursionDetected) {
                    console.warn('ì¬ê·€ ê°ì§€ë¡œ ì¸í•´ iframe ë¡œë“œ ì¤‘ë‹¨');
                    return false;
                }

                if (!validateWebhookUrl()) {
                    showErrorMessage('ì±—ë´‡ URLì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return false;
                }

                try {
                    n8nIframe.src = n8nWebhookUrl;
                    isChatLoaded = true;
                    console.log('âœ… iframe ì•ˆì „í•˜ê²Œ ë¡œë“œë¨');
                    return true;
                } catch (e) {
                    console.error('ğŸš¨ iframe ë¡œë“œ ì‹¤íŒ¨:', e);
                    showErrorMessage('ì±—ë´‡ì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return false;
                }
            }

            // === ì´ˆê¸°í™” ë° ë°©ì–´ ë¡œì§ ì‹¤í–‰ ===
            if (detectRecursion()) {
                // ì¬ê·€ ê°ì§€ ì‹œ ì¶”ê°€ ì‘ì—… ì¤‘ë‹¨
                return;
            }

            // iframe ì˜¤ë¥˜ ì²˜ë¦¬ ì„¤ì •
            setupIframeErrorHandling();

            // í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ë°©ì–´ ë¡œì§ í¬í•¨)
            chatToggleButton.addEventListener('click', () => {
                // ì¬ê·€ ê°ì§€ ì‹œ í´ë¦­ ë¬´ì‹œ
                if (isRecursionDetected) {
                    console.warn('ì¬ê·€ ê°ì§€ë¡œ ì¸í•´ í´ë¦­ ë¬´ì‹œ');
                    return;
                }

                // ì²˜ìŒ ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œë§Œ iframeì˜ srcë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. (ì„±ëŠ¥ ìµœì í™”)
                if (!isChatLoaded) {
                    if (!safeLoadIframe()) {
                        return; // ë¡œë“œ ì‹¤íŒ¨ ì‹œ í† ê¸€í•˜ì§€ ì•ŠìŒ
                    }
                }
                
                // 'visible' í´ë˜ìŠ¤ë¥¼ í† ê¸€í•˜ì—¬ ì±„íŒ…ì°½ì„ ë³´ì—¬ì£¼ê±°ë‚˜ ìˆ¨ê¹ë‹ˆë‹¤.
                chatWidgetContainer.classList.toggle('visible');
            });

            // === ì¶”ê°€ ì•ˆì „ì¥ì¹˜: í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬ ===
            window.addEventListener('beforeunload', () => {
                if (n8nIframe.src && n8nIframe.src !== 'about:blank') {
                    n8nIframe.src = 'about:blank';
                }
            });

        });
    </script>

</body>
</html>